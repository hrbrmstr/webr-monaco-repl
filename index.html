<!-- nolint: start -->
<html lang="en">

<head>
	<meta charset="utf-8" />
	<title>WebRIDEr: WebR + Monaco IDE</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta property="twitter:title" content="🧪 🕸️ WebRIDEr: WebR + Monaco IDE">
	<meta property="og:description" content="A Bare Bones IDE For Getting WebR Work Done">
	<meta property="twitter:description" content="A Bare Bones IDE For Getting WebR Work Done">
	<meta property="og:site" content="https://rud.is/w/webr-monaco-repl">
	<meta property="og:site_name" content="WebR Exeriments">
	<meta property="og:image:url" content="https://rud.is/w/webr-monaco-repl">
	<meta property="og:image:alt" content="example">
	<meta property="twitter:site_name" content="@hrbrmstr">
	<meta property="twitter:domain" content="rud.is">
	<meta property="twitter:card" content="summary_large_image">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.28.1/min/vs/loader.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.28.1/min/vs/editor/editor.main.min.css" />
	<link rel="stylesheet" href="index.css"/>

</head>

<body>
	<div class="container">
		<div id="editor" class="container__left"></div>
		<div class="resizer" data-direction="horizontal"></div>
		<div class="container__right">
			<div id="help" class="container__top">
			<canvas id="plot-canvas" width="1008" height="1008"></canvas>
			</div>
			<div class="resizer" data-direction="vertical"></div>
			<div id="output" class="container__bottom">
				<pre id="outpre"><code id="out"></code></pre>
			</div>
		</div>
	</div>
	
	<script type="module">

	import * as RLang from './rlang.js'
	import { rCompletions } from "./completions.js";
	import { cowsay, plotR, instructions } from "./boilerplate.js";
	import { Console } from 'https://webr.r-wasm.org/v0.1.1/webr.mjs';

	// setup our handlers for the Console
	const webRConsole = new Console({

		stdout: line => {
			const outpre = document.getElementById("outpre")
			outpre.innerText += line + '\n';
			outpre.scrollTop = outpre.scrollHeight;
		},

		stderr: line => {
			const outpre = document.getElementById("outpre")
			outpre.innerText += line + '\n';
			outpre.scrollTop = outpre.scrollHeight;
		},

		prompt: p => {
			const outpre = document.getElementById('outpre')
			outpre.innerText += "> "
			outpre.scrollTop = outpre.scrollHeight;
		},

		canvasExec: c => {
			Function(`document.getElementById('plot-canvas').getContext('2d').${c}`)()
		},

	});

	webRConsole.run();
	webRConsole.webR.init();

	globalThis.webRConsole = webRConsole; // handy

	// Configure the Monaco Editor
	require.config({
		paths: {
			'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.27.0/min/vs'
		}
	});

	require([ 'vs/editor/editor.main' ], function () {
		
		const savedCode = localStorage.getItem('savedCode') || `${instructions}\n\n${cowsay}\n\n${plotR}\n\n`;

		var editor = monaco.editor.create(document.getElementById('editor'), {
			value: savedCode,
			language: 'r',
			theme: 'vs-dark'
		});
					
		monaco.languages.register({ id: 'r' });
		monaco.languages.setMonarchTokensProvider('r', RLang.language)
		monaco.languages.setLanguageConfiguration('r', RLang.conf)
		monaco.languages.registerCompletionItemProvider('r', rCompletions);

		globalThis.editor = editor;

		// This handles sending stuff from the editor to R
		function sendInput() {
			
			var selectedText = editor.getModel().getValueInRange(editor.getSelection());
			
			if (!selectedText) {
				var lineNumber = editor.getPosition().lineNumber;
				selectedText = editor.getModel().getLineContent(lineNumber);
			}
			
			globalThis.webRConsole.stdin(selectedText);
			
			document.getElementById('outpre').innerText += selectedText + "\n";

			const outpre = document.getElementById("outpre")
			outpre.scrollTop = outpre.scrollHeight; // scroll into view
			
		}

		// this handles auto-save to local storage on change
		editor.onDidChangeModelContent(() => {
			const content = editor.getValue();
			localStorage.setItem('savedCode', content);
		});
		
		// cmd-shift-p to bring up the command palette
		editor.addCommand(
			monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KEY_P,
			() => {
				editor.getAction('editor.action.quickCommand').run();
			},
			''
		);

		// cmd-enter to run code
		editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, function () {
			sendInput();
		});

		// pair of functions to clear local storage and restore boilerplate
		function clearLocalStorage() {
			console.log("Clearing storage")
			localStorage.removeItem('savedCode');
			editor.setValue(`${instructions}\n\n${cowsay}\n\n${plotR}\n\n`)
		}

		editor.addAction({
			id: 'clear-local-storage',
			label: 'WebR: Clear Local Storage',
			keybindings: [ monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KEY_K ], // Optional: Assign a keybinding
			contextMenuGroupId: 'navigation',
			contextMenuOrder: 1.5,
			run: clearLocalStorage
		});
		
		// save the "canvas" as PNG
		editor.addAction({
			id: 'saveCanvas',
			label: 'WebR: Save Canvas as PNG…',
			run: function (editor) {
				var canvas = document.getElementById('plot-canvas');
				var dataURL = canvas.toDataURL('image/png');
				var link = document.createElement('a');
				link.download = 'canvas.png';
				link.href = dataURL;
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
			}
		});

		// save the source pane
		editor.addAction({
			id: 'saveSource',
			label: 'WebR: Save Source Pane…',
			keybindings: [
		    monaco.KeyMod.CtrlCmd | monaco.KeyMod.Alt | monaco.KeyCode.KEY_S
			],
			run: function (editor) {
				var source = editor.getValue();
				var blob = new Blob([ source ], { type: 'text/plain' });
				var link = document.createElement('a');
				link.href = URL.createObjectURL(blob);
				var fileName = prompt('Enter file name:', 'source.R');
				if (fileName === null) {
					return;
				}
				link.download = fileName;
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
			}
		});

    // cmd-option-p from anywhere
		document.addEventListener('keydown', function (event) {
			if ((event.ctrlKey || event.metaKey) && event.keyCode === 80) {
				event.preventDefault();
				var filename = 'source.r';
				var link = document.createElement('a');
				link.download = filename;
				link.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(editor.getValue());
				link.click();
			}
		});

		editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KEY_I, 
		function () {
			var currentPosition = editor.getPosition();
			editor.executeEdits("", [ {
				range: new monaco.Range(currentPosition.lineNumber, currentPosition.column, currentPosition.lineNumber, currentPosition.column),
				text: "|>"
			} ]);
		});

		editor.addCommand(monaco.KeyMod.Alt | monaco.KeyMod.Shift | monaco.KeyCode.US_MINUS,
			function () {
				var currentPosition = editor.getPosition();
				editor.executeEdits("", [ {
					range: new monaco.Range(currentPosition.lineNumber, currentPosition.column, currentPosition.lineNumber, currentPosition.column),
					text: "<-"
				} ]);
			});


	});
	</script>
	
	<script src="./resizers.js"></script>

</body>

</html>
<!-- nolint: end -->
